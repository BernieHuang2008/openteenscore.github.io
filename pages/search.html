<div class="content">
    <center>
        Searching
        <br>
        <br>
        <span id="loading"></span>
    </center>
</div>

<style>
    .content b {
        background-color: yellow;
        color: black;
    }

    .content {
        max-width: 800px;
        margin: 0 auto;
        margin-top: 60px;
        padding: 20px;

        color: white;
        border-radius: 6px;
        background-color: #fff3;
        backdrop-filter: blur(10px);
    }

    .content h2>a {
        color: #9cdcfe;
    }

    #loading {
        display: block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #fff;
        animation: loading 1s infinite;
    }

    @keyframes loading {
        0% {
            transform: scale(0);
        }

        100% {
            transform: scale(1);
            opacity: 0;
        }
    }
</style>

<script>
    function process(query) {
        // step 1: replace all punctuations with space
        var punctuations = /[,\.\/\?<>;:\'\"\\\|\[\]\{\}\(\)!@\#\$%\^\&\*~`\-_—=\+，。！？；：‘’“”【】《》〈〉、]/g
        query = query.replaceAll(punctuations, " ");
        // step 2: split with space
        query = query.split(" ");
        // step 3: split with jieba
        if (!jieba.ready) {
            return query;
        }
        for (var i = 0; i < query.length; i++) {
            query[i] = jieba.cut(query[i]);
        }
        // step 4: flatten the array
        query = query.flat();
        return query;
    }

    async function revidx(query) {
        var rev_index = JSON.parse(await HTTP_GET2("/search/index.json"));
        var content = {};	// 记录每个文件的内容
        var file = {};		// 记录每个文件里关键词的信息，indexed by filename
        var filecnt = {};	// 计算每个文件匹配的关键词数量，indexed by filename
        var filematch = {};	// 记录每个文件匹配的关键词，indexed by filename
        query.forEach(kw => {
            if (rev_index[kw]) {
                rev_index[kw][0].forEach(doc => {
                    var [filename, info] = doc;
                    // 记录到file
                    file[filename] = file[filename] || {};
                    file[filename][kw] = info;
                    // 计算到filecnt
                    filecnt[filename] = filecnt[filename] || 0;
                    filecnt[filename]++;
                    // 记录到filematch
                    filematch[filename] = filematch[filename] || [];
                    filematch[filename].push(kw);
                })
            }
        })
        // 获取每个文件的内容
        for (var filename in file) {
            content[filename] = await HTTP_GET2("/search/text/" + filename);
        }
        // console.log(content);
        // console.log(file);
        // console.log(filecnt);
        // console.log(filematch);

        result = [];
        for (var filename in filecnt) {
            result.push([filename, filecnt[filename]]);
        }
        result.sort((a, b) => b[1] - a[1]);

        var result_range = [];	// each item = [filename, pos_start, pos_end, [[hl1_s, hl1_e], [hl2_s, hl2_e]]]
        result.forEach(r => {
            var filename = r[0];
            var kw = filematch[filename][0];
            var info = file[filename][kw];
            var pos_start = info[1][0];	// info = [cnt, [pos1, pos2]]
            var pos_end = pos_start + kw.length;
            // hightlight
            var hl = [pos_start, pos_end];
            // set bound
            pos_start = Math.max(pos_start - 50, 0);
            pos_end = Math.min(pos_end + 50, content[filename].length);
            // push range
            result_range.push([filename, pos_start, pos_end, [hl]]);
        })

        // 处理连续的关键词
        // TODO: 这非常必要，但是我把自己写懵了。。。先放着吧

        /* result_multikw = {};	// 记录多个连续关键词的信息，indexed by 连续的关键词数量
        result.forEach(r => {
            var filename = r[0];
            var cnt = r[1];
            var info = file[filename];
            console.log(info);
            var kws = Object.keys(info);
    	
            function if_nearby(filename, a, b) {
                // var ia = info[a];	// [cnt, [pos1, pos2]]
                // var ib = info[b];
                // ia[1].forEach(pa => {
                // 	if (result === null) {
                // 		ib[1].forEach(pb => {
                // 			if (result === null) {
                // 				if (pb - pa - a.length < 3 || pa - pb - b.length < 3) {
                // 					// near by
                // 					result = [pa, pb];
                // 				}
                // 			}
                // 		})
                // 	}
                // })
                result = null;
                words = [a, b];
                infos = [a, b];
                function helper(i){
                    curr_w = words[i];
                    curr_i = infos[i];
                    curr_i[1].forEach(p => {
                        if (result === null) {
                            infos[1-i][1].forEach(p2 => {
                                if (result === null) {
                                    if (p2 - p - curr_w.length < 3 || p - p2 - words[1-i].length < 3) {
                                        // near by
                                        result = [p, p2];
                                    }
                                }
                            })
                        }
                    })
                }
                helper(0);
                return result;
            }
        })
        */


        // console.log(result_range)
        var result_content = [];	// each item = [filename, HTML]
        result_range.forEach(r => {
            var [fname, pos_start, pos_end, hl] = r;
            hl = hl.sort((a, b) => b[0] - a[0]);	// max first
            var c = content[fname].substring(pos_start, pos_end);
            // highlight
            hl.forEach(h => {
                // console.log(1, c);
                c = c.substring(0, h[0] - pos_start) + "<b>" + c.substring(h[0] - pos_start, h[1] - pos_start) + "</b>" + c.substring(h[1] - pos_start);
                // console.log(2, c);
            })
            result_content.push([fname, c]);
        })
        return result_content;
    }

    window.jieba = {
        onload: function () {
            // console.log(process("你好，我是黄瓜.bernie huang"));
        },
        ready: false,
    }
</script>

<script src="/search/scripts/data/dictionary.js"></script>

<script>
    var query = window.location.href.split('/')[4].trim().toLowerCase();
    $("#search>input").value = decodeURI(query);

    window.jieba.onload = async function () {
        var query = window.location.href.split('/')[4].trim().toLowerCase();
        query = decodeURI(query);
        query = process(query); // split query
        var result = await revidx(query);
        // console.log(result)
        var html = [];
        result.forEach(r => {
            r[0] = r[0].substring(0, r[0].length - 9);	// cut '.html.txt'
            html.push(`
				<div class="result">
					<h2><a href="/${r[0]}">${r[0]}</a></h2>
					<p>${r[1]}</p>
				</div>
				`)
        })
        document.querySelector(".content").innerHTML = html.join('<hr>');
    }
</script>